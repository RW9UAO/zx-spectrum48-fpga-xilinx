# zx-spectrum48-fpga-xilinx
zx spectrum48 fpga xilinx

внезапно захотелось странного. на форуме видел туториал от Ewgeny7 по сборке спектрума. но у него все было для альтеры и на VHDL, а я сижу на xilinx и verilog.  

для начала я к проекту прицепил ядро Т80, но он осбиралось с диким количеством warning и очень криво, например умный расстановщик выкидывал из проекта сигнал INT. а как собрать верно мне квалификации не хватает. пришлось искать вариант Z80 который бы точно жил под xilinx.  

нашел ядро https://github.com/gdevic/A-Z80. прицепил к тестовому проекту, все собралось корректно и даже стало что-то дрыгать по шинам адреса и данных.  

теперь настало время туториала, я вбил счетчики, генераторы синхронизаций. появилась картинка, стало веселее. при телодвижениях на шине данных памяти что-то происходит на картинке.  

в туториале используется внешний чип SRAM, у меня на плате его нет. точнее есть на плате с spartan 3AN, но там макроячеек даже на процессор не хватает. а на плате с spartan 6 стоит SDRAM на 64мб, коей надо еще и рулить уметь.  

но у нас же есть 32 блока по 18к блочной памяти! ура. делаем из нее 64кб оперативки. и что-то даже появляется на экране.  

теперь переходим к ROM. берем для начала тестовый образ. но BRAM чипа уже кончилась. ну ладно, у нас есть выделенная память, ее аж 130к. генерим корку, проект собирается, но ничего не происходит. развертка есть, черный экран.  

хм. а видеопамять вообще корректно выводится? вытаскиваем картинку-заставку из образа тетриса. и пихаем ее по нужному адресу при генерации RAM.  

вместо картинки фигня, бордюр не мигает, хотя явно что-то происходит. картинка "кипит", при ресете процессора стоит стабильно.  
тут вылезла ошибка записи в регистр xFE. тест отмигал бордюром, пошли полоски.  

и тут Зоркий Глаз разглядел на отладке чипу от Cypress из которой делают логические анализаторы. быстро прошил ей EEPORM saleae и прицепил к проекту. но 8 бит мало! там же два полных порта прицеплено. sigrok помог осуществить мечту.  

sigrok с fx2law работает с непрошитым ничем FX2LP чипом. и показывает 16 бит. но на 12мгц максимум. ибо надо слать в два раза больше данных.
итак, лог анализатор работает. и что мы видим? а фигню мы видим. память не успевает выставить данные! как так, BRAM работает на 500мгц же, а тут не успевает!  

стоп, она у нас синхронная, увеличиваем ей частоту с 14мгц до 150. и появляется картинка!  

ура, пошел тест памяти, прошел, показал, что все корректно. прогон в течении нескольких часов глюков не выявил.  

теперь собираем корку выделенной памяти под romBIOS спектрум48.  

и ждем 3 часа пока она проведет роутинг. еще и не работает что-то.  

3 часа на сборку проекта - это не серьезно! решил использовать 64кб блочной памяти сразу с образом romBiOS. заодно сделал заглушку на запись в нижние 16кб. собралось за привычные 10 минут.  

не работает. стал смотреть на лог анализаторе, что происходит по шинам. а там какой-то бред вообще. собрал с тестовой прошивкой, и вижу явно бред на шине данных. а откуда он берется? ага..... это данные для видеоконтроллера.  

делаем буферный регистр, в который будут защелкиваться данные для процессора и не пересекаться с данными от видеоконтроллера. это все прозрачный доступ.  

    // register for solid CPU data read from RAM
    // prevent data damage from video controller
    always @(negedge clock)begin
        if(vid_sel == 0 && cpu_rd_n == 0 && cpu_mreq_n == 0)begin
            sram_do_r <= sram_do;
        end
    end  
  
и вуаля! тест пошел! и прошел! и запустилась romBIOS48 и показала приветствие.  

# цепляем клавиатуру.  

по туториалу цепляем модуль клавиатуры, все собирается, но лезут какие-то глюки при работе компутера.  

оказывается у меня неправильный сигнал генерации прерывания. там какой-то мусор. чиним, попутно делаем его одинарный, шириной 8us. теперь вообще ничего не работает.  

делаем по туториалу, получается двойной сигнал прерывания. один шириной 8 us и за ним через 20 us еще один. но клавиатура работает. и корректно. и даже на BASIC48 можно написать програмку.  

в итоге все заработало корректно после устранения варнингов разводки.  


    //======================================================
    // INT inpulse generation
    always @(posedge clock) begin
        // generate two INT impulse, as in tutorial
        //if ( vcnt[9:1] == 239 && hcnt == 316) begin
        // for one INT impulse, work fine
        if ( vcnt == 478 && hcnt == 316) begin 
            int_signal <= 1'b1;
        end else begin
            int_signal <= 1'b0;
        end
    end

    always @(posedge clk_150mhz) begin
        if( int_signal == 1'b1) begin
            cpu_int_n <= 1'b0;
        end
        // 388-316=72 pix;  32/448 * 72  = 5.14uS from tutor
        //if ( hcnt == 388 ) begin	
        // 428-316=112 pix; 32/448 * 112 = 8uS as original
        if ( hcnt == 428 ) begin
            cpu_int_n <= 1'b1;
        end
    end


# улучшения и углубления

надо сделать click sound на нажатие кнопок. ибо в порт xFE мы уже пишем корректно. добавляем ножку на выход и вешаем динамик через усилитель. как оно орет!!! надо громкость снизить =)  

    assign BUZZER = port_fe[4];

т.к. у нас есть звук наружу, выведем и запись на магнитофон.  

    assign tape_out = port_fe[3];

а вот с вводом с магнитофона будут нюансы. просто подключить на GPIO спартана - я боюсь. а на плате не предусмотрено никакого буферного элемента. надо что-то сконструировать внешнее. пришлось на к561ЛН2 сделать ленинградскую схему. с ней не страшно.  

арканоид с первого раза не заработал. виснет на этапе игры. я решил, что ему не хватает кемпстон джойстика. и реализовал порт 31.  

    always @(*)begin
        if (cpu_a_bus[7:0] == 8'h1F && cpu_iorq_n == 0) begin
            port_1f_sel <= 1'b1;
        end else begin
            port_1f_sel <= 1'b0;
        end
    end

добавив в мультиплексор  

    assign cpu_d_bus =
    ....
    // read from kempston joy
    ( cpu_mreq_n == 1 && cpu_rd_n == 0 && port_1f_sel == 1) ? 
    { 3'b111, kempston} :

но арканоид так и не взлетел... тогда я полез смотреть, что происходит на шине. и оказалось, что он активно читает из порта xFF! это такая хитрая особенность оригинального спектрума. при чтении из несуществующих портов проц должен прочитать xFF, но из-за простой реализации декодера порта клавиатуры xFE, из нечетных портов читается атрибут текущего знакоместа. пришлось реализовать защелку для порта xFF:  

    always @(*)begin
        if (cpu_a_bus[7:0] == 8'hFF && cpu_iorq_n == 0) begin
            port_ff_sel <= 1'b1;
        end else begin
            port_ff_sel <= 1'b0;
        end
    end

и мультиплексор данных проца  

    // read read from xFF port
    ( cpu_mreq_n == 1 && cpu_rd_n == 0 && port_ff_sel == 1) ? 
    port_ff :  

но арканоид все равно не работает. оставим пока как есть. будем играть в BATTY.  
https://github.com/RW9UAO/zx-spectrum48-fpga-xilinx/blob/master/pict/20180609_103314.jpg
	
# мысли, возможно несбыточные.

на плате стоит SDRAM, хочется прицепить корку для управления ей, ибо хочется пентагон128, а то и kay1024.  

хочется звук, я помню были игрушки и демки для 48кб и AY звука. вроде накопал VHDL модель, надо прицепить. а заодно подумать, как три 8ми битных порта ЦАП сложить в стерео сигнал без ЦАП. можно сигма-дельта прицепить.  

а звук в итоге вывести на i2s звуковой ЦАП стоящий на отладочной плате.  

эмуляция флоппи с uSD карты. но тут поле непаханное вообще. даже не знаю как подходить.  
